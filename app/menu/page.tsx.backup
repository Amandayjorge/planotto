"use client";

import { useState, useEffect, useRef } from "react";
import { useRouter } from "next/navigation";
import { createPortal } from "react-dom";

const MENU_STORAGE_KEY = 'weeklyMenu';
const RECIPES_STORAGE_KEY = 'recipes';
const CELL_PEOPLE_COUNT_KEY = 'cellPeopleCount';
const WEEK_START_KEY = 'selectedWeekStart';

const INGREDIENT_UNITS = ['–≥', '–∫–≥', '–º–ª', '–ª', '—à—Ç', '—á.–ª.', '—Å—Ç.–ª.', '–ø–æ –≤–∫—É—Å—É'];
const DEFAULT_UNIT = '–≥';
const RECIPE_CATEGORIES = ['–ó–∞–≤—Ç—Ä–∞–∫', '–û–±–µ–¥', '–£–∂–∏–Ω', '–î–µ—Å–µ—Ä—Ç', '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ'];

// Helper function to format ingredient display
const formatIngredient = (ingredient: Ingredient): string => {
  if (ingredient.unit === '–ø–æ –≤–∫—É—Å—É') {
    return `${ingredient.name} ‚Äî –ø–æ –≤–∫—É—Å—É`;
  }
  return `${ingredient.amount} ${ingredient.unit} ${ingredient.name}`;
};

// Helper functions for week management
const getMonday = (date: Date): Date => {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  return new Date(d.setDate(diff));
};

const formatDate = (date: Date): string => {
  return date.toISOString().split('T')[0]; // YYYY-MM-DD
};

const formatDisplayDate = (date: Date): string => {
  return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
};

const getWeekRange = (weekStart: Date): string => {
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekEnd.getDate() + 6);
  return `${formatDisplayDate(weekStart)}‚Äì${formatDisplayDate(weekEnd)}`;
};

interface Ingredient {
  name: string;
  amount: number;
  unit: string;
}

interface MenuItem {
  id: string;
  type: "recipe" | "text";
  recipeId?: string;
  value?: string;
  includeInShopping?: boolean;
  ingredients?: Ingredient[];
  cooked?: boolean;
}

interface Recipe {
  id: string;
  title: string;
  categories?: string[];
}

export default function MenuPage() {
  const days = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"];
  const meals = ["–ó–∞–≤—Ç—Ä–∞–∫", "–û–±–µ–¥", "–£–∂–∏–Ω"];
  
  const [mealData, setMealData] = useState<Record<string, MenuItem[]>>({});
  const [recipes, setRecipes] = useState<Recipe[]>([]);
  const [hasLoaded, setHasLoaded] = useState(false);
  const [cellPeopleCount, setCellPeopleCount] = useState<Record<string, number>>({});
  const [weekStart, setWeekStart] = useState<string>(() => formatDate(getMonday(new Date())));
  const [addingItemCell, setAddingItemCell] = useState<string | null>(null);
  const modalRef = useRef<HTMLDivElement>(null);
  const [newItemType, setNewItemType] = useState<"recipe" | "text">("recipe");
  const [newItemText, setNewItemText] = useState("");
  const [newItemRecipeId, setNewItemRecipeId] = useState("");
  const [newItemIncludeInShopping, setNewItemIncludeInShopping] = useState(true);
  const [newItemIngredients, setNewItemIngredients] = useState<Ingredient[]>([{ name: "", amount: 0, unit: DEFAULT_UNIT }]);
  const [newItemPeopleCount, setNewItemPeopleCount] = useState(1);
  const [peopleInput, setPeopleInput] = useState("1");
  const [recipeCategoryFilter, setRecipeCategoryFilter] = useState<string>("–í—Å–µ");
  const [openMoreMenu, setOpenMoreMenu] = useState<string | null>(null); // Format: "cellKey-index"
  const [menuAnchor, setMenuAnchor] = useState<{itemId: string, rect: DOMRect} | null>(null);
  const [editingItem, setEditingItem] = useState<{cellKey: string, index: number} | null>(null);
  const [movingItem, setMovingItem] = useState<{cellKey: string, index: number} | null>(null);
  const [moveTargetDay, setMoveTargetDay] = useState<string>("");
  const [moveTargetMeal, setMoveTargetMeal] = useState<string>("");
  const router = useRouter();

  // Get storage keys for current week
  const getMenuStorageKey = () => `${MENU_STORAGE_KEY}:${weekStart}`;
  const getCellPeopleCountKey = () => `${CELL_PEOPLE_COUNT_KEY}:${weekStart}`;

  // Week navigation functions
  const goToPreviousWeek = () => {
    const currentDate = new Date(weekStart);
    currentDate.setDate(currentDate.getDate() - 7);
    setWeekStart(formatDate(currentDate));
  };

  const goToNextWeek = () => {
    const currentDate = new Date(weekStart);
    currentDate.setDate(currentDate.getDate() + 7);
    setWeekStart(formatDate(currentDate));
  };

  // Save week start to localStorage whenever it changes
  useEffect(() => {
    localStorage.setItem(WEEK_START_KEY, weekStart);
  }, [weekStart]);

  // Load data from localStorage on mount
  useEffect(() => {
    // Load selected week start
    const storedWeekStart = localStorage.getItem(WEEK_START_KEY);
    if (storedWeekStart) {
      setWeekStart(storedWeekStart);
    }

    const storedMenu = localStorage.getItem(getMenuStorageKey());
    if (storedMenu) {
      try {
        const parsedMenu = JSON.parse(storedMenu);
        // Convert single items to arrays for backward compatibility
        const convertedMenu: Record<string, MenuItem[]> = {};
        for (const [key, value] of Object.entries(parsedMenu)) {
          const items = ensureArray(value as any);
          // Apply backward compatibility to each item
          convertedMenu[key] = items.map(item => ensureTextItemCompatibility(item));
        }
        setMealData(convertedMenu);
      } catch (error) {
        console.error("Failed to load menu data:", error);
      }
    }

    const storedRecipes = localStorage.getItem(RECIPES_STORAGE_KEY);
    if (storedRecipes) {
      try {
        const parsedRecipes = JSON.parse(storedRecipes);
        console.log("Loading recipes from localStorage:", parsedRecipes);
        setRecipes(parsedRecipes);
      } catch (error) {
        console.error("Failed to load recipes:", error);
      }
    } else {
      console.log("No recipes found in localStorage");
    }

    const storedCellPeopleCount = localStorage.getItem(getCellPeopleCountKey());
    if (storedCellPeopleCount) {
      try {
        const parsedCellPeopleCount = JSON.parse(storedCellPeopleCount);
        setCellPeopleCount(parsedCellPeopleCount);
      } catch (error) {
        console.error("Failed to load cell people count:", error);
      }
    }
    setHasLoaded(true);
  }, [weekStart]); // Reload data when week changes

  // Save data to localStorage whenever mealData changes (but only after initial load)
  useEffect(() => {
    if (!hasLoaded) return;
    localStorage.setItem(getMenuStorageKey(), JSON.stringify(mealData));
  }, [mealData, hasLoaded, weekStart]);

  // Save cell people count to localStorage whenever it changes
  useEffect(() => {
    if (!hasLoaded) return;
    localStorage.setItem(getCellPeopleCountKey(), JSON.stringify(cellPeopleCount));
  }, [cellPeopleCount, hasLoaded, weekStart]);

  const [cookedStatus, setCookedStatus] = useState<Record<string, boolean>>({});

  useEffect(() => {
    if (!hasLoaded) return;
    localStorage.setItem(`cookedStatus:${weekStart}`, JSON.stringify(cookedStatus));
  }, [cookedStatus, hasLoaded, weekStart]);

  useEffect(() => {
    const storedCookedStatus = localStorage.getItem(`cookedStatus:${weekStart}`);
    if (storedCookedStatus) {
      try {
        const parsedCookedStatus = JSON.parse(storedCookedStatus);
        setCookedStatus(parsedCookedStatus);
      } catch (error) {
        console.error("Failed to load cooked status:", error);
      }
    }
  }, [weekStart]);

  const getCellKey = (day: string, meal: string) => `${day}-${meal}`;

  // Helper function to check if a specific day is in the past
  const isDayInPast = (dayIndex: number): boolean => {
    const currentDate = new Date(weekStart);
    currentDate.setDate(currentDate.getDate() + dayIndex - 1); // Subtract 1 to get correct day
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Set to start of day for comparison
    currentDate.setHours(0, 0, 0, 0);
    return currentDate < today;
  };

  // Helper function to get default cooked status based on date and saved override
  const getDefaultCookedStatus = (dayIndex: number, itemId?: string): boolean => {
    // If there's an explicit saved override for this item, use it
    if (itemId && cookedStatus[itemId] !== undefined) {
      return cookedStatus[itemId];
    }
    // Otherwise, default based on whether day is in the past
    return isDayInPast(dayIndex);
  };

  // Backward compatibility helper: ensure menu cell data is always an array
  const ensureArray = (items: MenuItem | MenuItem[] | undefined): MenuItem[] => {
    if (!items) return [];
    if (Array.isArray(items)) return items;
    return [items];
  };

  // Backward compatibility helper: ensure text items have required fields
  const ensureTextItemCompatibility = (item: MenuItem): MenuItem => {
    if (item.type === "text") {
      return {
        ...item,
        includeInShopping: item.includeInShopping ?? true,
        ingredients: item.ingredients || [],
        cooked: item.cooked ?? false
      };
    }
    return item;
  };

  const getDisplayText = (items: MenuItem[] | undefined): string => {
    if (!items || items.length === 0) return "";
    // For now, display the first item to maintain current behavior
    const item = items[0];
    if (item.type === "recipe" && item.recipeId) {
      const recipe = recipes.find(r => r.id === item.recipeId);
      return recipe ? recipe.title : "";
    }
    return item.value || "";
  };

  const isManualEntry = (items: MenuItem[] | undefined): boolean => {
    if (!items || items.length === 0) return false;
    // For now, check the first item to maintain current behavior
    return items[0].type === "text";
  };

  const clearCell = (e: React.MouseEvent, key: string) => {
    e.stopPropagation();
    setMealData(prev => {
      const newData = { ...prev };
      delete newData[key];
      return newData;
    });
  };

  const clearWeek = () => {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –º–µ–Ω—é –Ω–∞ –≤—Å—é –Ω–µ–¥–µ–ª—é?")) {
      setMealData({});
      localStorage.removeItem(getMenuStorageKey());
    }
  };

  const getEffectivePeopleCount = (key: string) => {
    return cellPeopleCount[key] || 1;
  };

  const updateCellPeopleCount = (key: string, count: number) => {
    setCellPeopleCount(prev => {
      const updated = { ...prev };
      if (count <= 0) {
        delete updated[key];
      } else {
        updated[key] = count;
      }
      return updated;
    });
  };

  const generateShoppingList = () => {
    // Store meal data and people counts in sessionStorage for shopping list page
    const dishNames = Object.values(mealData).map(item => getDisplayText(item)).filter(name => name.trim() !== "");
    sessionStorage.setItem('menuDishes', JSON.stringify(dishNames));
    sessionStorage.setItem('cellPeopleCount', JSON.stringify(cellPeopleCount));
    router.push('/shopping-list');
  };

  // Functions for handling multiple items
  const handleAddItemClick = (key: string) => {
    setAddingItemCell(key);
    setNewItemType("recipe");
    setNewItemText("");
    setNewItemRecipeId("");
    setNewItemIncludeInShopping(true);
    setNewItemIngredients([{ name: "", amount: 0, unit: DEFAULT_UNIT }]);
    setNewItemPeopleCount(getEffectivePeopleCount(key));
    setPeopleInput(getEffectivePeopleCount(key).toString()); // Reset string input
    setRecipeCategoryFilter("–í—Å–µ");
  };

  const handleAddItemConfirm = () => {
    if (!addingItemCell) return;

    // Parse and clamp people count on submit
    const parsedPeopleCount = parseInt(peopleInput) || 1;
    const clampedPeopleCount = Math.max(1, parsedPeopleCount);
    setNewItemPeopleCount(clampedPeopleCount);
    setPeopleInput(clampedPeopleCount.toString());

    // Save the people count for this cell
    updateCellPeopleCount(addingItemCell, clampedPeopleCount);

    const newItem: MenuItem = newItemType === "recipe" 
      ? { type: "recipe", recipeId: newItemRecipeId, cooked: false, id: crypto.randomUUID() }
      : { 
          type: "text", 
          value: newItemText.trim(),
          includeInShopping: newItemIncludeInShopping,
          ingredients: newItemIncludeInShopping 
            ? newItemIngredients.filter(ing => ing.name.trim() && (ing.unit === '–ø–æ –≤–∫—É—Å—É' || ing.amount > 0))
            : [],
          cooked: false,
          id: crypto.randomUUID()
        };

    if (newItemType === 'recipe' && !newItemRecipeId) return;
    if (newItemType === 'text' && !newItemText.trim()) return;

    if (editingItem) {
      // Edit mode: update existing item
      setMealData(prev => ({
        ...prev,
        [addingItemCell]: prev[addingItemCell]?.map((item, index) => 
          index === editingItem.index ? newItem : item
        ) || [newItem]
      }));
      setEditingItem(null);
    } else {
      // Add mode: add new item
      setMealData(prev => ({
        ...prev,
        [addingItemCell]: [...(prev[addingItemCell] || []), newItem]
      }));
    }

    setAddingItemCell(null);
    setNewItemText('');
    setNewItemRecipeId('');
    setNewItemIncludeInShopping(true);
    setNewItemIngredients([{ name: '', amount: 0, unit: DEFAULT_UNIT }]);
    setNewItemPeopleCount(1);
  };

  const handleRemoveItem = (cellKey: string, itemIndex: number) => {
    setMealData((prev) => {
      const currentItems = prev[cellKey] || [];
      const newItems = currentItems.filter((_, index) => index !== itemIndex);

      if (newItems.length === 0) {
        const newData = { ...prev };
        delete newData[cellKey];
        return newData;
      }

      return {
        ...prev,
        [cellKey]: newItems,
      };
    });
  };

  const handleAddItemCancel = () => {
    setAddingItemCell(null);
    setEditingItem(null);
    setNewItemText('');
    setNewItemRecipeId('');
    setNewItemIncludeInShopping(true);
    setNewItemIngredients([{ name: '', amount: 0, unit: DEFAULT_UNIT }]);
    setNewItemPeopleCount(1);
    setPeopleInput("1"); // Reset string input
  };

  const handleMoreMenuToggle = (e: React.MouseEvent, menuKey: string, itemId: string) => {
    e.stopPropagation();
    const target = e.currentTarget as HTMLElement;
    const rect = target.getBoundingClientRect();
    
    if (openMoreMenu === menuKey) {
      setOpenMoreMenu(null);
      setMenuAnchor(null);
    } else {
      setOpenMoreMenu(menuKey);
      setMenuAnchor({ itemId, rect });
    }
  };

  const handleDeleteItem = (cellKey: string, itemIndex: number) => {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —ç–ª–µ–º–µ–Ω—Ç?')) {
      handleRemoveItem(cellKey, itemIndex);
    }
    setOpenMoreMenu(null);
  };

  const handleEditItem = (cellKey: string, itemIndex: number) => {
    const item = mealData[cellKey]?.[itemIndex];
    if (!item) return;

    // Set editing state
    setEditingItem({ cellKey, index: itemIndex });
    setAddingItemCell(cellKey);

    // Populate form with item data
    if (item.type === 'recipe') {
      setNewItemType('recipe');
      setNewItemRecipeId(item.recipeId || '');
    } else {
      setNewItemType('text');
      setNewItemText(item.value || '');
      setNewItemIncludeInShopping(item.includeInShopping ?? true);
      setNewItemIngredients(item.ingredients || [{ name: '', amount: 0, unit: DEFAULT_UNIT }]);
    }

    setNewItemPeopleCount(getEffectivePeopleCount(cellKey));
    setPeopleInput(getEffectivePeopleCount(cellKey).toString());
    setRecipeCategoryFilter("–í—Å–µ");
    setOpenMoreMenu(null);
  };

  const handleIngredientChange = (index: number, field: keyof Ingredient, value: string | number) => {
    setNewItemIngredients((prev) => {
      const updated = [...prev];
      updated[index] = { ...updated[index], [field]: value };
      return updated;
    });
  };

  const addIngredientField = () => {
    setNewItemIngredients((prev) => [...prev, { name: '', amount: 0, unit: DEFAULT_UNIT }]);
  };

  const removeIngredientField = (index: number) => {
    setNewItemIngredients((prev) => prev.filter((_, i) => i !== index));
  };

  // Move functionality handlers
  const handleMoveClick = (cellKey: string, itemIndex: number) => {
    setMovingItem({ cellKey, index: itemIndex });
    setMoveTargetDay("");
    setMoveTargetMeal("");
    setOpenMoreMenu(null);
  };

  const handleMoveConfirm = () => {
    if (!movingItem || !moveTargetDay || !moveTargetMeal) return;

    const fromKey = movingItem.cellKey;
    const fromIndex = movingItem.index;
    const toKey = getCellKey(moveTargetDay, moveTargetMeal);

    setMealData(prev => {
      const newData = { ...prev };
      const fromItems = prev[fromKey] || [];
      const toItems = prev[toKey] || [];

      // Get the item to move
      const itemToMove = fromItems[fromIndex];
      if (!itemToMove) return prev;

      // Remove from source
      const newFromItems = fromItems.filter((_, index) => index !== fromIndex);

      // Add to destination
      const newToItems = [...toItems, itemToMove];

      // Update the data
      if (newFromItems.length === 0) {
        delete newData[fromKey];
      } else {
        newData[fromKey] = newFromItems;
      }
      newData[toKey] = newToItems;

      return newData;
    });

    // Reset move state
    setMovingItem(null);
    setMoveTargetDay("");
    setMoveTargetMeal("");
  };

  const handleMoveCancel = () => {
    setMovingItem(null);
    setMoveTargetDay("");
    setMoveTargetMeal("");
  };

  // Helper function to filter recipes by category
  const getFilteredRecipes = () => {
    if (recipeCategoryFilter === "–í—Å–µ") {
      return recipes;
    }
    if (recipeCategoryFilter === "–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏") {
      return recipes.filter(recipe => !recipe.categories || recipe.categories.length === 0);
    }
    return recipes.filter(recipe => recipe.categories?.includes(recipeCategoryFilter));
  };

  // Handle outside clicks to close more menu and move selector
  useEffect(() => {
    const handleOutsideClick = (event: PointerEvent) => {
      if (openMoreMenu || movingItem) {
        const target = event.target as Node;
        // Check if click is outside any more menu or move selector
        const isInsideMenu = target && (
          (target as Element).closest('.menu-grid__item-menu') ||
          (target as Element).closest('.menu-grid__item-more') ||
          (target as Element).closest('.menu-grid__move-selector')
        );
        if (!isInsideMenu) {
          setOpenMoreMenu(null);
          if (movingItem) {
            handleMoveCancel();
          }
        }
      }
    };

    if (openMoreMenu || movingItem) {
      document.addEventListener('pointerdown', handleOutsideClick, true);
    }

    return () => {
      document.removeEventListener('pointerdown', handleOutsideClick, true);
    };
  }, [openMoreMenu, movingItem]);

  // Portal component for dropdown menu
  const DropdownMenu = () => {
    if (!menuAnchor) return null;

    const { itemId, rect } = menuAnchor;
    const dropdownWidth = 150;
    
    // Calculate position to avoid overflow
    let left = rect.right - dropdownWidth;
    let top = rect.bottom + 6;
    
    // Flip horizontally if would overflow right
    if (left < 0) {
      left = rect.left;
    }
    
    // Flip vertically if would overflow bottom
    if (top + 200 > window.innerHeight) {
      top = rect.top - 200 - 6;
    }

    return createPortal(
      <div
        className="menu-grid__item-menu-portal"
        style={{
          position: 'fixed',
          left: `${left}px`,
          top: `${top}px`,
          zIndex: 9999,
          background: 'white',
          border: '1px solid #ddd',
          borderRadius: '4px',
          boxShadow: '0 2px 8px rgba(0,0,0,0.15)',
          minWidth: `${dropdownWidth}px`
        }}
      >
        <button
          onClick={() => handleEditItem(menuAnchor.itemId.split('-')[0], parseInt(menuAnchor.itemId.split('-')[1]))}
          className="menu-grid__item-menu-edit"
        >
          –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <button
          onClick={() => handleMoveClick(menuAnchor.itemId.split('-')[0], parseInt(menuAnchor.itemId.split('-')[1]))}
          className="menu-grid__item-menu-move"
        >
          –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏
        </button>
        <button
          onClick={() => handleDeleteItem(menuAnchor.itemId.split('-')[0], parseInt(menuAnchor.itemId.split('-')[1]))}
          className="menu-grid__item-menu-delete"
        >
          –£–¥–∞–ª–∏—Ç—å
        </button>
      </div>,
      document.body
    );
  };

  return (
    <section className="card">
      <div className="menu-header">
        <h1 className="h1">–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</h1>
        <div className="week-navigation">
          <button className="week-nav-btn" onClick={goToPreviousWeek}>
            ‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è
          </button>
          <span className="week-range">–ù–µ–¥–µ–ª—è: {getWeekRange(new Date(weekStart))}</span>
          <button className="week-nav-btn" onClick={goToNextWeek}>
            –°–ª–µ–¥—É—é—â–∞—è –Ω–µ–¥–µ–ª—è ‚Üí
          </button>
        </div>
      </div>
      <p className="muted" style={{ marginBottom: '16px', fontSize: '14px' }}>
        üí° –¢–æ–ª—å–∫–æ —Ä–µ—Ü–µ–ø—Ç—ã —Å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫. –¢–µ–∫—Å—Ç–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è.
      </p>

      <div className="menu-grid-scroll">
        <div className="menu-grid">
        <div className="menu-grid__header">
          <div className="menu-grid__empty"></div>
          {days.map((day, dayIndex) => {
            const currentDate = new Date(weekStart);
            currentDate.setDate(currentDate.getDate() + dayIndex);
            return (
              <div key={day} className="menu-grid__day-header">
                {day} {formatDisplayDate(currentDate)}
              </div>
            );
          })}
        </div>

        {meals.map((meal) => (
          <div key={meal} className="menu-grid__row">
            <div className="menu-grid__meal-label">{meal}</div>
            {days.map((day, dayIndex) => {
              const key = getCellKey(day, meal);
              const item = mealData[key];
              const displayText = getDisplayText(item);

              return (
                <div
                  key={key}
                  className="menu-grid__cell"
                  data-cell-key={key}
                >
                  <div className="menu-grid__cell-content">
                    <div className="menu-grid__items">
                      {item && item.length > 0 ? (
                        item.map((menuItem, index) => {
                          const menuKey = `${key}-${index}`;
                          return (
                            <div key={index} className="menu-grid__item">
                              <span className="menu-grid__item-text">
                                {menuItem.type === 'recipe' && menuItem.recipeId
                                  ? recipes.find((r) => r.id === menuItem.recipeId)?.title || ''
                                  : menuItem.value || ''}
                              </span>
                              <label className="menu-grid__cooked-label">
                                <input
                                  type="checkbox"
                                  checked={getDefaultCookedStatus(dayIndex, menuItem.id)}
                                  onChange={(e) => {
                                    const updatedItems = [...(mealData[key] || [])];
                                    updatedItems[index] = {
                                      ...updatedItems[index],
                                      cooked: e.target.checked
                                    };
                                    setMealData(prev => ({
                                      ...prev,
                                      [key]: updatedItems
                                    }));
                                    // Save cooked status override
                                    setCookedStatus(prev => ({
                                      ...prev,
                                      [menuItem.id]: e.target.checked
                                    }));
                                  }}
                                  className="menu-grid__cooked-checkbox"
                                />
                                –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–æ
                              </label>
                              <button
                                className="menu-grid__item-more"
                                onClick={(e) => handleMoreMenuToggle(e, menuKey, menuItem.id)}
                                title="–î–µ–π—Å—Ç–≤–∏—è"
                              >
                                ‚ãØ
                              </button>
                              {openMoreMenu === menuKey && (
                                <div className="menu-grid__item-menu">
                                  <button
                                    onClick={() => handleEditItem(key, index)}
                                    className="menu-grid__item-menu-edit"
                                  >
                                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                  </button>
                                  <button
                                    onClick={() => handleMoveClick(key, index)}
                                    className="menu-grid__item-menu-move"
                                  >
                                    –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏
                                  </button>
                                  <button
                                    onClick={() => handleDeleteItem(key, index)}
                                    className="menu-grid__item-menu-delete"
                                  >
                                    –£–¥–∞–ª–∏—Ç—å
                                  </button>
                                </div>
                              </div>
                            </div>
                          );
                        })
                      ) : (
                        <span className="menu-grid__placeholder">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</span>
                      )
                    </div>

                    {(item && item.length > 0) && (
                      <div className="menu-grid__cell-badges">
                        <span className="menu-grid__people-badge">
                          {getEffectivePeopleCount(key)} —á–µ–ª
                        </span>
                        {item.some((mi) => mi.type === 'text') && (
                          <span className="menu-grid__manual-badge">–±–µ–∑ —Ä–µ—Ü–µ–ø—Ç–∞</span>
                        )
                      </div>
                    )}

                    <div className="menu-grid__cell-actions">
                      <button
                        className="menu-grid__add"
                        onClick={(e) => {
                          e.stopPropagation();
                          handleAddItemClick(key);
                        }}
                        title="–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ"
                      >
                        +
                      </button>
                    </div>
                  </div>
                </div>
              );
            })
          </div>
        </div>
      </div>

      <DropdownMenu />
      
      <div className="menu-actions">
        <button
          className="menu-actions__generate-btn"
          onClick={generateShoppingList}
          disabled={Object.values(mealData).filter((item) => getDisplayText(item).trim() !== '').length === 0}
{{ ... }
        >
          –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫
        </button>

        <button
          className="menu-actions__clear-btn"
          onClick={clearWeek}
          disabled={Object.keys(mealData).length === 0}
        >
          –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–¥–µ–ª—é
        </button>
      </div>

      {/* Add Item Dialog */}
      {addingItemCell && (
        <div 
          className="menu-dialog-overlay"
        >
          <div 
            ref={modalRef} 
            className="menu-dialog"
            onMouseDown={(e) => e.stopPropagation()}
          >
            <h3>{editingItem ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ'}</h3>

            <div className="menu-dialog__type-selector">
              <label>
                <input
                  type="radio"
                  name="itemType"
                  value="recipe"
                  checked={newItemType === 'recipe'}
                  onChange={(e) => setNewItemType(e.target.value as 'recipe' | 'text')}
                />
                –†–µ—Ü–µ–ø—Ç
              </label>
              <label>
                <input
                  type="radio"
                  name="itemType"
                  value="text"
                  checked={newItemType === 'text'}
                  onChange={(e) => setNewItemType(e.target.value as 'recipe' | 'text')}
                />
                –¢–µ–∫—Å—Ç
              </label>
            </div>

            <div className="menu-dialog__people-count">
              <label>
                –°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫?
                <input
                  type="number"
                  value={peopleInput}
                  onChange={(e) => setPeopleInput(e.target.value)}
                  className="menu-dialog__people-input"
                  min="1"
                  step="1"
                />
              </label>
            </div>

            {newItemType === 'recipe' ? (
              <div className="menu-dialog__recipe-selector">
                <div className="menu-dialog__category-filter">
                  <label>
                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è:
                    <select
                      value={recipeCategoryFilter}
                      onChange={(e) => setRecipeCategoryFilter(e.target.value)}
                      className="menu-dialog__select"
                    >
                      <option value="–í—Å–µ">–í—Å–µ</option>
                      {RECIPE_CATEGORIES.map(category => (
                        <option key={category} value={category}>{category}</option>
                      ))}
                      <option value="–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    </select>
                  </label>
                </div>
                <select
                  value={newItemRecipeId}
                  onChange={(e) => setNewItemRecipeId(e.target.value)}
                  className="menu-dialog__select"
                >
                  <option value="">–í—ã–±—Ä–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç...</option>
                  {getFilteredRecipes().map((recipe) => (
                    <option key={recipe.id} value={recipe.id}>
                      {recipe.title}
                    </option>
                  ))}
                </select>
              </div>
            ) : (
              <div className="menu-dialog__text-input">
                <input
                  type="text"
                  value={newItemText}
                  onChange={(e) => setNewItemText(e.target.value)}
                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."
                  className="menu-dialog__input"
                  autoFocus
                />

                <div className="menu-dialog__shopping-option">
                  <label>
                    <input
                      type="checkbox"
                      checked={newItemIncludeInShopping}
                      onChange={(e) => setNewItemIncludeInShopping(e.target.checked)}
                    />
                    –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫
                  </label>
                </div>

                {newItemIncludeInShopping && (
                  <div className="menu-dialog__ingredients">
                    <h4>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</h4>
                    {newItemIngredients.map((ingredient, index) => (
                      <div key={index} className="menu-dialog__ingredient-row">
                        <input
                          type="text"
                          value={ingredient.name}
                          onChange={(e) => handleIngredientChange(index, 'name', e.target.value)}
                          placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"
                          className="menu-dialog__ingredient-name"
                        />
                        <input
                          type="number"
                          value={ingredient.amount || ''}
                          onChange={(e) => handleIngredientChange(index, 'amount', parseFloat(e.target.value) || 0)}
                          placeholder="–ö–æ–ª-–≤–æ"
                          className="menu-dialog__ingredient-amount"
                          min="0"
                          step="0.1"
                        />
                        {INGREDIENT_UNITS.includes(ingredient.unit) ? (
                          <select
                            value={ingredient.unit}
                            onChange={(e) => handleIngredientChange(index, 'unit', e.target.value)}
                            className="menu-dialog__ingredient-unit"
                          >
                            {INGREDIENT_UNITS.map((unit) => (
                              <option key={unit} value={unit}>
                                {unit}
                              </option>
                            ))}
                            <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                          </select>
                        ) : (
                          <input
                            type="text"
                            value={ingredient.unit}
                            onChange={(e) => handleIngredientChange(index, 'unit', e.target.value)}
                            placeholder="–ï–¥. –∏–∑–º."
                            className="menu-dialog__ingredient-unit"
                          />
                        )}
                        <button
                          type="button"
                          onClick={() => removeIngredientField(index)}
                          className="menu-dialog__ingredient-remove"
                          title="–£–¥–∞–ª–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç"
                        >
                          √ó
                        </button>
                      </div>
                    ))}
                    <button
                      type="button"
                      onClick={addIngredientField}
                      className="menu-dialog__add-ingredient"
                    >
                      + –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
                    </button>
                  </div>
                )}
              </div>
            )}

            <div className="menu-dialog__actions">
              <button
                onClick={handleAddItemConfirm}
                disabled={
                  (newItemType === 'recipe' && !newItemRecipeId) ||
                  (newItemType === 'text' && !newItemText.trim())
                }
                className="menu-dialog__confirm"
              >
                –î–æ–±–∞–≤–∏—Ç—å
              </button>
              <button onClick={handleAddItemCancel} className="menu-dialog__cancel">
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        </div>
      )}
    </section>
  );
}